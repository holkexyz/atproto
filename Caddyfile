{
    email admin@{$PDS_HOSTNAME:pds.example}
}

# PDS API + handle resolution (wildcard)
{$PDS_HOSTNAME:pds.example}, *.{$PDS_HOSTNAME:pds.example} {
    @notauth not host auth.{$PDS_HOSTNAME:pds.example}

    handle @notauth {
        reverse_proxy {$PDS_UPSTREAM:pds:3000} {
            # WebSocket support for AT Protocol event streams
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
        }
    }

    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
    }
}

# Auth service (separate origin for security isolation)
auth.{$PDS_HOSTNAME:pds.example} {
    reverse_proxy {$AUTH_UPSTREAM:auth:3001}

    header {
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://{$PDS_HOSTNAME:pds.example}"
        Referrer-Policy "no-referrer"
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    }
}
